# 保存

　Pythonによりファイル保存する。

* JavaScript
    * ファイルダウンロード
        * plain-text
        * SQLite3
    * IndexedDB（XSS攻撃の危険性あり！）
* Python
    * ファイル保存
        * plain-text
        * SQLite3

# 秘密情報の保存

　Pythonによるローカル保存はJSによるブラウザ保存より安全かつ便利。XSS攻撃は受けないし、パス指定してユーザ操作を省略できるから。

* アカウント（パスワード、APIキー（AccessToken））
* ウォレット（秘密鍵）
* 位置情報（緯度・経度。自宅位置を保存することで太陽高度を計算し自動配色する）
* 公開前の著作物（作品。公開前に他人に盗まれて先に公開されうる）
* SSH秘密鍵

# Python保存

* ファイル保存（plain-text）
    * 保存形式を事前に決めておく（plain-text／SQLite3／両方）
    * 保存方法を事前に決めておく（上書き／diff+patch／日時別別({workId}_{yyyymmddHHMMSS}.ja)）
    * 保存先パスを事前に決めておく（デフォルト：./save/{authorId}/{workId}.ja, works.db, ./save/authors.db）

```toml
[save]
path = './save' # default/{app}/{cd}
format = 'sqlite3' # default/text/db plain-text/sqlite3 both/full/all
method = 'overwrite' # default/overwrite/patch/daily
```

　無効値ならデフォルト値とする。

　基本的に作品公開後は常に`diff+patch`で固定。設定しても普遍。設定はあくまで公開前の話。公開後に旧版の状態を閲覧できるようにするため。特に誤字指摘URLを有効にするため。

# データ移行

　自分の所有する別のデバイスに、自分のデータを全部まるごと移行する。基本的にアプリのディレクトリ配下全部コピーすればいいだけ。USBメモリにファイルコピーするなどの方法で十分可能。ただしデバイスによってはmicroSDカードしか読み込めない等の問題でコピーできないことがある。かといってインターネット上のオンラインストレージを利用するのは情報漏洩のリスクがあるため避けたい。そこで選択肢を増やすため、BlueTooth通信、P2P等によるマシン間通信により、全データのコピーを実装したい。

# データ通信

　作品公開にあたりネット上でなく、ごく身近な友人だけに送りたい時がある。これをBlueToothにより実装したい。特に自宅のPCで著者情報などの秘密情報を含めて全情報をもちつつ、そのうち渡したい作品データだけをスマホに入れて、友人のスマホとBlueTooth通信してファイルを渡したい。

　スマホはPCより盗聴されやすいため暗号化したほうがいい。あるいは数日後に自動削除されるようにしたい。

* javel形式（本文(簡易Markdown)+メタ情報(YAML)）
* 独立HTML形式（閲覧アプリがない場合でもオフラインで閲覧可）
* 自滅アプリ（所定のパスワード入力成功で閲覧可。パスワードで暗号化された原稿。指定日時で自滅するがJSでの実装は無理）

# 公開

　インターネット上に作品を公開したい。HTTPSサーバにデプロイすることでアプリをインストールせず閲覧できる。あるいは永続化できる。原稿ファイルをダウンロードしたり、お気に入り作品をjavel形式ファイルから閲覧したりURLまたは原稿をDBに保存するブラウザ拡張機能が欲しい。さらにIPFSでP2P通信によりHTTPSサーバがなくとも公開できるようにしたい。

# 方針

　自動保存が最適。新規作成やら上書き保存といったファイル操作を一切しないのが望ましい。

　ファイル保存方針は以下。

* 必要な保存をすることで作業損失を防ぐ
* 不要な保存を減らすことでHDD/SSDの劣化を最小限にする

　以下のような不測の事態により作業損失が起きうる。

* 停電による電源断
* フリーズにより手動電源断

　いつ起きるかわからないため備えるべきだが、頻繁に保存しすぎるとHDD/SSDの劣化を招く。最適な保存について次の項目を考慮する。

* 別名保存する条件（デフォルト値から変更した／前回保存値から変更した）
* 保存タイミング（アプリ終了時／変更後から一定時間経過）
* 保存パス（OS含むドライブ／外部ストレージ／複数／オンラインストレージ）

1. デフォルト／前回値のまま変更なし（自動保存せず）
1. 非デフォルト値（自動保存候補）
1. 変更済み＆一定時間経過（自動保存する）※一定時間ごとに自動保存するか否かはユーザ設定次第
1. 変更済み＆手動保存（CTRL+S等）
1. 変更済み＆アプリ終了（自動保存する）

　一定時間経過による保存はデフォルトでは1時間に設定しておく。OFFにすることも可能。最小単位は1分。最長24時間。

　保存パスはデフォルトでは一つ。アプリのルートディレクトリ配下にある`./save/`直下にSQLite3形式で保存する。
　ただしリスク分散のため、他のパスに変更したり、同時に複数のパスへ保存できるようにする。パスを変えれば外部ストレージにも保存可能。さらにオンラインストレージによる保存も可能（ただしSQLite3ファイルを暗号化する。復号化されたら秘密情報をすべて盗まれる）

　次のような保存戦略が考えられる。

A. 毎回ローカルに保存する
B. 毎回GitHubへpushする（ローカルには一切保存しない）
C. 一定時間経過や手動による保存はRAMディスクにだけ保存し、アプリ終了後にのみHDDディスクに保存する

　Aは最も安全。作業損失を避けつつ情報漏洩もない。ただしHDD/SSDの劣化が最も激しい。
　Bは最もHDD/SSDの劣化が少ない。ただし情報漏洩リスクやパケット通信が最大。
　Cはアプリ終了まで一切保存しない。途中で停電などが起きたら作業損失する。

## 作品選択

　アプリで本文やメタ情報を編集できるのはひとつの作品のみ。どの作品を編集するか選択する必要がある。

* 著者
    * 作品

　まず著者があり、その作品がある。アプリは複数の著者を作れる。もしひとつの著者しかいなければ自動選択される。

　著者情報はユーザが入力する必要がある。名前、Webサービスアカウント、暗号通貨アドレス等。ただし著者をひとつも作らずとも作品を書くことができる。その場合は「名無しの権兵衛」となる。これは著者ID0番で、著者情報がない場合の固定名である。

　作品はメタ情報がなくとも作成できる。ただしタイトルもないため検索しにくい。このときタイトルは「無題」となる。作成・更新日時にもとづき一覧に出せる。存在する情報は日時と字数のみ。タイトル、キャッチコピー、紹介文は存在しない。書かずとも本文だけで作れる。

　最短ワークフローは以下。同一作品を更新する。

1. アプリを起動する
1. 前回終了時の作品を表示する
1. 本文を書く
1. アプリを終了する

　別の作品を選んで更新する。

1. アプリを起動する
1. 前回終了時の作品を表示する
1. 作品一覧から別の作品を選択する
1. 本文を書く
1. アプリを終了する

　新規作成する。

1. アプリを起動する
1. 作品を新規作成する
1. 本文を書く
1. アプリを終了する

　新規作成と作品選択の操作は省略できない。ただし前回終了時の作品選択と保存は省略できる。

* 新規作成
* 上書き保存
* エクスポート
* 作品選択

## 新規作成

　Ctrl+Nキー、[＋]ボタン押下により作品を新規作成する。SQLite3のworksテーブルにレコードが追加される。このとき本文やタイトルは所定のデフォルト値である。本文デフォルト値はHowToUseな内容にする。

　ユーザ設定によって新規作成時のデフォルト値を以下のいずれかに変更できる。

* 固定デフォルト値にする
* 指定デフォルト値にする
* 新規作成時にユーザ選択する

　本文のデフォルト値は以下のパターンがある。

* 空
* HowToUse
* ユーザが入力した任意値

　メタ情報も同じように選べる。

* 名無しの権兵衛
* 最初に作成したユーザ
* 指定したユーザ

## エクスポート

　SQLite3に保存してある作品を他の形式に変換して出力する。

* javel形式ファイル
* html形式ファイル

　javel形式ファイルは閲覧アプリがあればページ送りして閲覧できる。最悪、テキストエディタがあれば読める。

　html形式ファイルはjavel形式をHTMLにパースした後の状態。静的サイトになる。全文含むall.html版と、見出しごとにファイル分断してある版がある。`0.html`, `1.html`, ...。なお`0.html`は表紙。最後にアプリ版。これは閲覧アプリとjavel形式ファイルが含まれており、配色や書字方向、ページ送りなどができる。

　全部で以下７パターン。

* javel形式
* 固定HTML一つ(全文)
* 固定HTML複数(見出し毎)
* 固定HTML複数(印刷・製本用 (A6(平綴じ／中綴じ／無線綴じ)))
* 閲覧アプリHTML＋javel形式データ埋込
* HTTPSデプロイ用（閲覧アプリHTML＋javel形式外部ファイル（fetch API読込））
* HTTPSデプロイ用（閲覧アプリHTML＋全作品SQLite3外部ファイル（fetch API読込））

## 作品選択

* all.db
    * authors
    * works
    * revisions

authors

列|型|値例
--|--|----
id|int|0
name|str(32)|名無《なな》しの権兵衛《ごんべえ》
file_name(64)|nanashino-gonbee
location|`{longitude:0.0, latitude:0.0}` 緯度,経度
key|`{pub:xxxxxxxx-xxxxxxxxx-xxxxxxxxx, pri:xxxxxxxx-xxxxxxxxx-xxxxxxxxx}`
accounts|`{github:{domain:'',user:{id:'',name:'',password:'',accessToken:''}}, 'mastodon':{instances:{domain:'mstdn.jp', user:}}}`
wallets|`{mona:{address:xxxx, pri:xxxxx}}`

works

列|型|値例
--|--|----
id|int|0
aid|int|0
title|str(100)|無題
catch|str(100)|
intro|str(200)|
category|str(100)|
genre|str(100)|
length|int|（文字数。word-count）
created|date|
updated|date|
published|date|
body|str|

revisions

列|型|値例
--|--|----
id|int|0
wid|int|0
version|int|0
patch|str|

　他にも作品固有のデフォルト値を設定したい。たとえば以下。ただ、強調以外は読者固有の設定に従うべきかもしれない。その上、細かすぎる。よってDB保存する値としては不適当。アプリ内で常時固定とすることで同じ見た目で統一したほうがいいかもしれない。

* `<em>`の強調表示文字（ゴマ、●、▲等）
* 書字方向（`writing-mode:vertical-rl;`）
* 配色（`dark-mode`）
* フォントファミリー

accounts

列|型|値例
--|--|----
id|int|0
name|str|名無《なな》しの権兵衛《ごんべえ》

wallets

列|型|値例
--|--|----
id|int|0
name|str|名無《なな》しの権兵衛《ごんべえ》

　ウォレットに関してはPythonで作成し、秘密情報保持しつつ送金したい。ただ、保存形式をSQLite3にするのは危険。せめて暗号化したい。またはバイナリファイルにしたい。

　別のウォレットアプリから相互にデータ移行できるようにしたい。

　できれば残高や送金先・日時・金額も保存しておきたい。別ウォレットによる送金は対象外でいい。

